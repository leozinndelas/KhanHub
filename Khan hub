local function debug(message)
    print("[DEBUG] " .. message)
end

local config = {
    farmRadius = 50,
    lowHealthThreshold = 30,
    healDelay = 5,
    attackInterval = 0.5,
    retreatPoint = Vector3.new(0, 100, 0),
    heightOffset = 5
}

local function getNearestEnemy()
    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    local enemies = game.Workspace.Enemies:GetChildren()
    local nearestEnemy, shortestDistance = nil, config.farmRadius

    for _, enemy in pairs(enemies) do
        if enemy:FindFirstChild("HumanoidRootPart") and enemy:FindFirstChild("Humanoid") then
            local distance = (rootPart.Position - enemy.HumanoidRootPart.Position).Magnitude
            if distance < shortestDistance then
                nearestEnemy = enemy
                shortestDistance = distance
            end
        end
    end

    return nearestEnemy
end

local function monitorHealth()
    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:FindFirstChild("Humanoid")

    if humanoid and humanoid.Health / humanoid.MaxHealth * 100 < config.lowHealthThreshold then
        debug("Vida baixa, recuando...")
        character.HumanoidRootPart.CFrame = CFrame.new(config.retreatPoint)
        wait(config.healDelay)
    end
end

local function attackEnemy(enemy)
    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local rootPart = character:FindFirstChild("HumanoidRootPart")

    if enemy and enemy:FindFirstChild("Humanoid") and enemy:FindFirstChild("HumanoidRootPart") then
        debug("Atacando inimigo: " .. enemy.Name)

        while enemy.Parent and enemy.Humanoid.Health > 0 and isFarming do
            local enemyPosition = enemy.HumanoidRootPart.Position
            rootPart.CFrame = CFrame.new(enemyPosition + Vector3.new(0, config.heightOffset, 0))

            if not enemy:FindFirstChild("Humanoid") or enemy.Humanoid.Health <= 0 then
                debug("Inimigo derrotado!")
                break
            end

            wait(config.attackInterval)
        end
    end
end

local function autoFarm()
    debug("Iniciando o Auto-Farming...")
    while isFarming do
        pcall(function()
            monitorHealth()
            local enemy = getNearestEnemy()
            if enemy then
                attackEnemy(enemy)
            else
                debug("Nenhum inimigo prÃ³ximo encontrado.")
                wait(1)
            end
        end)
    end
end

local screenGui = Instance.new("ScreenGui")
screenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
screenGui.Name = "KhanHub"

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 300, 0, 150)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -75)
mainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
mainFrame.Active = true
mainFrame.Draggable = true

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0.3, 0)
title.Position = UDim2.new(0, 0, 0, 0)
title.Text = "KhanHub - By Leozin"
title.TextColor3 = Color3.new(1, 1, 1)
title.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
title.BorderSizePixel = 0
title.Font = Enum.Font.SourceSansBold
title.TextSize = 20
title.Parent = mainFrame

local autoFarmButton = Instance.new("TextButton")
autoFarmButton.Size = UDim2.new(0.8, 0, 0.4, 0)
autoFarmButton.Position = UDim2.new(0.1, 0, 0.35, 0)
autoFarmButton.Text = "Ativar Auto-Farm"
autoFarmButton.TextColor3 = Color3.new(1, 1, 1)
autoFarmButton.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
autoFarmButton.BorderSizePixel = 0
autoFarmButton.Font = Enum.Font.SourceSansBold
autoFarmButton.TextSize = 18
autoFarmButton.Parent = mainFrame

local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, 0, 0.2, 0)
statusLabel.Position = UDim2.new(0, 0, 0.8, 0)
statusLabel.Text = "Status: Desativado"
statusLabel.TextColor3 = Color3.new(1, 1, 1)
statusLabel.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
statusLabel.BorderSizePixel = 0
statusLabel.Font = Enum.Font.SourceSans
statusLabel.TextSize = 16
statusLabel.Parent = mainFrame

isFarming = false

autoFarmButton.MouseButton1Click:Connect(function()
    isFarming = not isFarming
    if isFarming then
        statusLabel.Text = "Status: Ativado"
        autoFarmButton.Text = "Desativar Auto-Farm"
        spawn(autoFarm)
    else
        statusLabel.Text = "Status: Desativado"
        autoFarmButton.Text = "Ativar Auto-Farm"
    end
end)
